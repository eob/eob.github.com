



































































































































<!doctype html>


  <meta charset="utf-8">


<title>Managing State across an Ant Swarm of AWS Lambda Tasks - Edward Benson</title>

<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<!-- Define a description for better SEO result -->
<meta name="description" content="Background tasks are a critical component of web applications. These tasks often perform work that takes too long to place inside the request-response loop of the app server. For example, many of our tasks at Cloudstitch involve synchronizing data between...">

<!-- Cheome Web App theme color -->
<meta name="theme-color" content="#ff00b4">

<!-- Feed URL -->
<link rel="alternate" href="/feed.xml" type="application/atom+xml">

<!-- Site icons -->

  
    

    

    
      <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    
      <link rel="icon" href="/favicon.png" type="image/png">
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    
      <link rel="mask-icon" href="/mask-icon.svg" color="#ff00b4">
    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  
    

    

    
  


<!-- Chrome Web App manifest -->
<link rel="manifest" href="/manifest.json">

<!-- Main CSS -->
<link rel="stylesheet" href="/assets/themes/curtana/css/app.css?assets-inline">

<!-- Canonical links, avoid duplicate content problems -->
<link rel="canonical" href="http://0.0.0.0:4321/2015/07/managing-state-across-lambda">

<!-- DNS prefetching for static files -->


<!-- browser-sync, don't remove this -->
<!-- BS_INSERT -->

<!-- Head hooks -->


<!-- Open Graph and Twitter Cards support, more info: https://dev.twitter.com/docs/cards -->
<meta property="og:type" content="article">
<meta property="og:site_name" content="Edward Benson">
<meta property="og:title" content="Managing State across an Ant Swarm of AWS Lambda Tasks">
<meta property="og:url" content="http://0.0.0.0:4321/2015/07/managing-state-across-lambda">
<meta property="og:description" content="Background tasks are a critical component of web applications. These tasks often perform work that takes too long to place inside the request-response loop of the app server. For example, many of our tasks at Cloudstitch involve synchronizing data between...">
<meta property="og:image" content="https://cdn-images-1.medium.com/max/1600/1*5YwojmmyjZ-AHvbIRvZw6w.png">

<meta name="twitter:card" content="summary_large_image">


  <meta name="twitter:site" content="@sparanoid">



  <meta name="twitter:creator" content="@edwardbenson">



  <meta property="article:published_time" content="2015-07-13T00:00:00-07:00">
  <meta property="article:modified_time" content="">
  <meta name="twitter:label1" value="Words">
  <meta name="twitter:data1" value="814 words">
  <meta name="twitter:label2" value="Reading time">
  <meta name="twitter:data2" value="4 mins">


<!-- Post specified styles -->
<style data-assets-inline>
  /*
    TODO: You have to speicify background color for `html` in order to make `-webkit-filter` work
    Link: https://bugs.chromium.org/p/chromium/issues/detail?id=591015
    Date: Mar 1, 2016, 5:41 PM
  */
  html {
    
  }

  body {
    

    

    
  }

  

  

  

  
  
    

  

  

  /*
    TODO: Need a better solution. I have to redefine the whole box-shadow here because no invidual box-shadow-color exists
    Date: Mar 12, 2016, 12:09 AM
  */
  

  

  

  
</style>

<!-- Main navigation with current page / categoriy highlighted -->
<nav class="navigation">
  <ul>
    
      








      
      
      <li >
        <a href="/">
          
            Writing
          
        </a>
      </li>
    
      








      
      
      <li >
        <a href="/research/">
          
            Research
          
        </a>
      </li>
    
      








      
      
      <li >
        <a href="/about/">
          
            About
          
        </a>
      </li>
    
  </ul>
</nav>

<!-- Main content wrap -->
<main class="content " role=main>
  



































































































































<!-- Post-wide custom CSS -->

  


<!-- Article wrapper, limit width -->
<article 
  
>

  <!-- Post title -->
  <header 
  style="     "
>

    <h1 class="
  
" title="Managing State across an Ant Swarm of AWS Lambda Tasks" data-title="Managing State across an Ant Swarm of AWS Lambda Tasks">
      
  
    
  
    Managing State across an Ant Swarm of AWS Lambda Tasks<span class="dot dot--post"> </span>
  

  

    </h1>

    
      <small>
        By <span rel="author">Ted Benson</span>
        on <time datetime="2015-07-13T00:00:00-07:00">Jul 13, 2015</time>
      </small>
    

    

  </header>

  <!-- Post content -->
  <div class="post-content">
    <p>Background tasks are a critical component of web applications. These tasks often
perform work that takes too long to place inside the request-response loop of
the app server. For example, many of our tasks at
<a href="http://www.cloudstitch.com/">Cloudstitch</a> involve synchronizing data between
third-party services like Eventbrite and Google Spreadsheets.</p>

<p>The typical background task setup most of us are used to is what you might call
the <strong>Big Fat Worker Machine Model</strong>. Whole computers, maybe EC2 instances,
running whatever you want. In this setup, handling a background task is as
simple as writing a program that takes and input and saves an output.</p>

<p><img src="https://cdn-images-1.medium.com/max/1600/1*5YwojmmyjZ-AHvbIRvZw6w.png" alt="" />
<span class="figcaption_hack">The <strong>Big Fat Worker</strong> model of background tasks.</span></p>

<p>But with the growing microservice trend, this worker-machine model no works. The
web of background tasks on AWS Lambda look more like a swarm of ants each
contributing a bit of labor to a piece of meat dropped on the ground. Some are
working in parallel. Others show up later to finish the job off. And messaging
between workers isn’t always explicit and linear: services like AWS Lambda
encourage execution to be triggered implicitly, via S3 and DynamoDB events,
rather than explicitly via function calls or queue pushes.</p>

<p><img src="https://cdn-images-1.medium.com/max/1600/1*4eeQrojcm8paSeLiHdEoOQ.png" alt="" />
<span class="figcaption_hack">A single background task accomplished with an <strong>Ant Swarm</strong> of workers.</span></p>

<p>Managing state across all the workers in that ant swarm can be a challenge:</p>

<ul>
  <li>The work is split across many, possibly parallel workers</li>
  <li>Some execution, invocation, and restart control is ceded to the platform</li>
  <li>No global scope exists to monitor the state of the entire ant swarm operation at
once</li>
</ul>

<p>I’ve tried a lot of different approaches to handling this problem while building
<a href="http://www.cloudstitch.com/">Cloudstitch</a>, and while I don’t have a silver
bullet solution, I have settled on a pattern that seems to be working well
enough to share. That approach is to **coordinate background tasks with
log-append job records in S3 (or DynamoDB). **What follows is targeted at the
AWS ecosystem but easily adaptable to other microservice infrastructures.</p>

<p>Here’s how it works. Each background task stores its state in a a job file. This
file is <em>logically</em> one JSON object, but <em>physically</em> a log structure of
refinements to some initiating object. Each <strong>job-n</strong> is an overwriting
refinement to <strong>job-{n-1}</strong>. That means the task is initially represented by a
single physical JSON object uploaded to S3. As microservices contribute work to
the task, they modify the state of the task by creating new files.</p>

<p><span class="figcaption_hack">Your job metadata is logically one file, but physically a time-ordered log
structure in S3.</span></p>

<p>This strategy enables easy leveraging of the events S3 can throw to Lambda.
<strong>Every time a refinement is appended to the log, it triggers a re-evaluation of
the overall job status. **That’s done by a router function which acts as the ant
queen, so to speak, to keep an eye on the swarm of ants as they report on their
status. When **job-n.json</strong> is uploaded, the router is triggered, downloads and
merges **job-{1:n}.json **into a single state object, and decides what to do
next.</p>

<p>The lifecycle ends up looking like a back and forth between S3 events, the
router function, and worker functions:</p>

<ul>
  <li><strong>Creation. **Uploading an initial **job.json</strong> file to S3 kicks off the router,
which begins issuing lambda calls (or pushing log refinements which, passively
trigger more work).</li>
  <li><strong>Ant Swarm.</strong> Each piece work done finishes with a log append in S3, triggering
the router to take a look and possibly request more work. For example, if all 10
of 10 web scraping sub-tasks are complete, the router might decide to initiate
the next phase of labor.</li>
  <li><strong>Completion</strong>. Eventually, a log append is pushed that results in the logical
job file achieving some completion state. In this case the router finishes the
job off — notifying callers, saving to a database, whatever is appropriate.</li>
</ul>

<p>Overall, I’m pretty pleased with the setup. It’s a bit more work up front to
organize a cascade of tasks this way, and there’s admittedly a lot bookkeeping
overhead if your sub-tasks are small, but it scales wonderfully.</p>

<p><strong>Here’s an NPM module called **<a href="https://www.npmjs.com/package/pile-on">Pile
On</a></strong> I’ve created to help manage JSON
objects and arrays of this access pattern.** This just helps with the file
management described above. For example, you can:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Create a new Job File
Pileon.create(S3Bucket, 'job.json', {state: 'running', x: 1});

// Append/overwrite the Job File
Pileon.append(S3Bucket, 'job.json', {state: 'finished', y: 3});

// Fetch a promise for the merged file
// {state: finished, x: 1, y:3}
var promise = Pileon.readObject(S3Bucket, 'job.json');
</code></pre></div></div>

<p>I’ve got a few more helper libraries I’ll be packaging down the road to handle
the execution management of jobs managed this way. In the meantime I’d love your
thoughts. It’s a wild world of experimentation out there in microservice land
and I know there are a lot differing strategies.</p>


    
    

    
  </div>

</article>


</main>

<!-- Footer section -->

  <footer class="footer">
    <ul>
      <li><a href="/">Edward Benson</a></li>
      <li><a href="http://www.twitter.com/edwardbenson" title="@edwardbenson">@edwardbenson</a></li>

      

      <li><a href="/feed.xml" title="Feed - Atom (The Atom Syndication Format)">Atom</a></li>
    </ul>
  </footer>


<!-- Theme scripts -->
<script src="/assets/themes/curtana/js/app.js?assets-inline"></script>

<!-- User scripts -->
<script src="/assets/js/user.js?assets-inline"></script>

<!-- Lightense Images -->


<!-- Service Worker  -->

  


<!-- Google Analytics -->

  


<!-- Foot hooks -->



